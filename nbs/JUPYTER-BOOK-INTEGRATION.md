# Jupyter Book Integration

This document provides a detailed overview of the modifications and enhancements made to integrate and optimize Jupyter Book within the existing project repository. The enhancements primarily focus on improving the visual appeal of the Jupyter Book PDF output and ensuring efficient workflow.

## How to use this repository

- Copy the files into the `nbs/` folder of your typical `nbdev` repository.
- Modify file `_toc.yml` to reflect the structure you want to have for your pdf.
- Run 

```bash
   python bin/build_jupyterbook_with_images.py
   ```

You should now have a pdf file of your notebooks in folder `_build/pdf`.


## Custom Styling for Jupyter Book

To enhance the visual appeal of the Jupyter Book, custom CSS styles have been implemented. These styles affect the layout, typography, and overall aesthetic of both the HTML and PDF versions generated by Jupyter Book.

### Key Features:

- **Typography**: Customized fonts and line spacing for improved readability.
- **Color Scheme**: A carefully selected color palette that is consistent across all pages.
- **Code Styling**: Enhanced styling for code blocks and inline code for better distinction from regular text.
- **Navigation Menu**: A revamped navigation menu with intuitive design for ease of navigation.

The custom styles can be found in the `_static/custom_styles.css` file. To modify these styles, edit this file and rebuild the book using Jupyter Book commands.

## Script for Image Inclusion and Book Building

The `build_jupyterbook_with_images.py` script has been developed to streamline the process of including images in the PDF version of the Jupyter Book. This script automates the copying of image files to the correct directory and triggers the Jupyter Book build process.

### Usage:

1. Place the script in the `bin` directory at the root of your Jupyter Book project.
2. Run the script using the command:

   ```bash
   python bin/build_jupyterbook_with_images.py
   ```

The script prompts for confirmation before proceeding with the operations, ensuring user control over the process.

## Fix for pyppeteer.errors.TimeoutError

A common issue encountered during PDF generation (`pyppeteer.errors.TimeoutError`) has been addressed by modifying the `pdf.py` file in the Jupyter Book or pyppeteer environment.

### Modification:

The line in `pdf.py` responsible for page navigation has been altered to:

```python
await page.goto(f"file:///{html_file}", {"timeout": 0, "waitUntil": ["networkidle2"]})
```

This change eliminates the timeout restriction, allowing for the complete loading of pages, thereby resolving the timeout issue during PDF creation.

## Fix for 

If you encounter the error 

`VersionConflict(dist, req).with_context(dependent_req)
pkg_resources.ContextualVersionConflict: (mdit-py-plugins 0.4.0 (lib/python3.10/site-packages), Requirement.parse('mdit-py-plugins~=0.3.1'), {'myst-parser'})`

This error is a dependency conflict, specifically with the `mdit-py-plugins` package. The core of the issue is that your environment has `mdit-py-plugins` version 0.4.0 installed, but `myst-parser`, a dependency for Jupyter Book, requires a version close to `0.3.1` (`~=0.3.1` indicates a version compatible with `0.3.1` but less than `0.4.0`).

To resolve this issue, you need to downgrade `mdit-py-plugins` to a version compatible with `myst-parser`. Here's how you can do it:

1. **Activate your environment**: Ensure you're working in the correct environment where Jupyter Book is installed.

   ```bash
   source activate underwatersystems
   ```

2. **Downgrade `mdit-py-plugins`**: Use `pip` to install a version of `mdit-py-plugins` that is compatible with `myst-parser`.

   ```bash
   pip install "mdit-py-plugins~=0.3.1"
   ```

   This command will uninstall the current version of `mdit-py-plugins` and install a version that is compatible with your current setup.

3. **Verify the installation**: After downgrading, it's a good practice to check if the correct versions are installed and if there are any other conflicting dependencies.

   ```bash
   pip list
   ```

   Look through the list to confirm that `mdit-py-plugins` is now the correct version and there are no other conflicting packages.

4. **Retry building your Jupyter Book**: Once the dependencies are sorted out, try rebuilding your Jupyter Book.

   ```bash
   python bin/build_jupyterbook_with_images.py
   ```

5. **Check for further dependency conflicts**: If you encounter additional dependency issues, you might need to repeat a similar processâ€”identifying the conflict and adjusting package versions accordingly.



## Specifying Page Breaks in Jupyter Notebooks for PDF Output

When converting Jupyter Notebooks to PDF, especially through Jupyter Book, it is often necessary to control the pagination by inserting page breaks. This can be achieved through raw HTML or LaTeX commands, depending on the method used for PDF generation.

### Using Raw HTML (For HTML-based PDF Conversion)

1. **Inserting a Page Break**: In your Jupyter Notebook, add a new cell and change its type to "Raw". In this cell, input the following HTML code:

    ```html
    <div style="page-break-after: always;"></div>
    ```

2. **Effect in PDF**: This tag will instruct the PDF renderer (when using HTML-based conversion like `pdfhtml` in Jupyter Book) to insert a page break at that point in the document.

### Using LaTeX Commands (For LaTeX-based PDF Conversion)

1. **Inserting a LaTeX Page Break**: Add a new "Raw" cell in your notebook and input the following LaTeX command:

    ```latex
    \newpage
    ```

2. **Effect in PDF**: This command will cause a new page to start at that point when converting the notebook to PDF using LaTeX-based methods.

### Considerations:

- **Compatibility**: The method chosen for inserting page breaks should align with the conversion tool used (HTML vs. LaTeX).

- **Notebook Interface**: These commands are only functional in the PDF output and will not affect the appearance of the notebook in the Jupyter interface.

- **Custom Styles**: Ensure that any custom CSS or LaTeX styling in your Jupyter Book configuration does not override these page break commands.

